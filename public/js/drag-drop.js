let draggedCard=null,sourceContainer=null;document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('.task-card').forEach(c=>{c.addEventListener('dragstart',e=>{draggedCard=e.target;sourceContainer=e.target.closest('.tasks-container');e.target.classList.add('dragging')});c.addEventListener('dragend',e=>{e.target.classList.remove('dragging');document.querySelectorAll('.tasks-container').forEach(c=>c.classList.remove('drag-over'))})});document.querySelectorAll('.tasks-container').forEach(c=>{c.addEventListener('dragover',e=>{e.preventDefault();e.dataTransfer.dropEffect='move'});c.addEventListener('dragenter',e=>e.currentTarget.classList.add('drag-over'));c.addEventListener('dragleave',e=>{if(e.target===e.currentTarget)e.currentTarget.classList.remove('drag-over')});c.addEventListener('drop',e=>{e.preventDefault();const target=e.currentTarget,newStatus=target.dataset.status,oldStatus=draggedCard.dataset.status;if(target===sourceContainer){target.classList.remove('drag-over');return}const taskId=draggedCard.dataset.taskId;target.appendChild(draggedCard);draggedCard.dataset.status=newStatus;updateCounts();target.classList.remove('drag-over');fetch('index.php?route=update-status',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:taskId,status:newStatus})}).then(r=>r.json()).then(d=>{if(!d.success){sourceContainer.appendChild(draggedCard);draggedCard.dataset.status=oldStatus;updateCounts();alert('Erreur')}}).catch(()=>{sourceContainer.appendChild(draggedCard);draggedCard.dataset.status=oldStatus;updateCounts();alert('Erreur réseau')})})});function updateCounts(){document.querySelectorAll('.kanban-column').forEach(col=>{const cnt=col.querySelector('.tasks-container'),count=cnt.querySelectorAll('.task-card').length,badge=col.querySelector('.task-count');if(badge)badge.textContent=count;const empty=cnt.querySelector('.empty-column');if(count===0&&!empty){const div=document.createElement('div');div.className='empty-column';div.innerHTML='<i class="fas fa-inbox"></i><p>Aucune tâche</p>';cnt.appendChild(div)}else if(count>0&&empty)empty.remove()})}});
